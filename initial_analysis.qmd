---
title: "Your Document Title"
format: html
execute:
  echo: true          # Show code chunks
  warning: false      # Hide warnings
  error: false        # Hide error messages
  message: false      # Hide messages (like library loading messages)
  cache: false        # Set to true if you want to cache results
  freeze: auto        # Prevents re-execution unless code changes
knitr:
  opts_chunk:
    fig.align: center  # Center figures
    fig.width: 8       # Default figure width
    fig.height: 6      # Default figure height
    out.width: "80%"   # Scale output width
    dpi: 300          # High resolution figures
---

#### research questions:

what evidence of this ideological gender divide exists in the UK and is it different across generations?

young peopleʼs attitudes and if we can challenge the idea theyʼre a monolith

how do the above translate into public-facing guidance for the FTSE CEO?

what is the divide? do economic or social views drive the divide that we're experiencing? can this be drilled down into specific areas of either?

```{r}
source('scripts/setup.R')
```

#### Analysis plan

1)  Verify data integrity, create composite social/economic scales

2)  Generate average scorings based on age-group, calculate differences by individual to age-group scores - how do individual differ from their age cohort?

3)  Quantify the size of gender differences in liberal/authoritarian attitudes across age groups:

-   did the 2024 vote exhibit the gender gap? (age/vote distribution by party vote 2024)
-   is the gap wider amongst younger generations vs. other? (gap size by age band)
-   specific issue gaps?

4)  Modelling stage - how does age, gender, other demographics predict ideology?

-   how can we predict party vote, conservatism, economic leftism using the demographic information that we have (weighted regression)?

5)  Segmented modelling - how do young people experience different effects to those of all voters?

-   Forest plot comparing model coefficients (full sample vs. young people)
-   Predicted value plot incorporating gender/age from the model

6)  Visualization creation, draw out most relevant insights from the above stages

7)  Extended segment analysis

-   What specific ideological markers are significant for corporate positioning strategy? What specific dimension is driving the growing gender divide for the future?
-   is this happening mostly in urban areas? can we merge in additional data via use of constituency codes?

8)  Based on above results, incorporate into a unified tracking function in new document

-   Test this function using survey waves from randomly selected batches from the main data, label for multiple months as proof of concept working.

### How do we measure political ideology?

1)  social preferences - conservatism variable

2)  economic preferences - economic leftism variable

3)  2024 party vote - between reform, labour, greens, conservatives, etc.

4)  Tailored topic viewpoints - big business, traditional values, death penalty etc.

<!-- First stage analysis (basically, where do things stand now?, what is the state of the gender gap across generations from the information that we have now?): -->

<!-- -   Quantify the size of gender differences in liberal/authoritarian attitudes across age groups -->

<!-- -   Show if the gap is wider among younger generations (18-34) vs other -->

<!-- -   Key metric: Gap size in composite social attitudes scale by age band -->

<!-- -   weighted regression model - effect of age, gender, age:gender interaction, education, ethnicity, region, household, religion, social_grade classification, marital status on conservatism + economic leftism + combined right-wing score -->

<!-- 3) Specific guidance - how can messaging and PR change for the company? -->

<!-- -   Challenge the "young monolith" assumption by showing attitude distributions within 18-34 demographic -->

<!-- -   Segment young men vs young women across both economic and social dimensions -->

<!-- -   Identify distinct clusters for targeted messaging -->

<!-- 4) Tracking Dashboard Framework -->

<!-- -   Automated functions to monitor changes over time -->

<!-- -   Key indicators: gender gap trends, generational shifts, attitude polarization metrics -->

<!-- -   Proof of concept using monthly splits from current data -->

#### 1) Verify data quality/integrity

```{r}
library(VIM)
#VIM::aggr(uk_data, plot = FALSE)

#unique(uk_data$eu_ref)


# we treat don't know as missing data
# sapply(uk_data[,c(3:6, 11:27)], unique)

# apply unique to all data

# encode NA's appropriately
uk_data <- uk_data %>%
  mutate(across(everything(), ~case_when(
    .x == "Don't know" ~ NA,
    .x == "dk" ~ NA,
    .x == "no_answer" ~ NA,           # religion column
    .x == "prefer_not_to_say" ~ NA,   # marital column
    TRUE ~ .x
  )))

VIM::aggr(uk_data, plot = FALSE)

```

Generally very few NAs in the data. Roughly equal rates across survey questions.

#### 2) Create Composite Economic/Social Ideology Scales

```{r}
# Function to recode attitude responses to -1 to 1 scale
recode_attitude <- function(x) {
  case_when(
    x == "Strongly agree" ~ 1,
    x == "Agree" ~ 0.5,
    x == "Neither agree nor disagree" ~ 0,
    x == "Disagree" ~ -0.5,
    x == "Strongly disagree" ~ -1,
    TRUE ~ NA_real_
  )
}

# Convert attitude variables to numeric and create scales
uk_data_test <- uk_data %>%
  mutate(
    # Convert social attitude variables to numeric (-2 to 2 scale)
    soc_respect = recode_attitude(soc_respect),
    soc_deathpen = recode_attitude(soc_deathpen),
    soc_schools = recode_attitude(soc_schools),
    soc_censor = recode_attitude(soc_censor),
    soc_punish = recode_attitude(soc_punish),
    # Convert economic attitude variables to numeric (-2 to 2 scale)
    econ_redist = recode_attitude(econ_redist),
    econ_bigbiz = recode_attitude(econ_bigbiz),
    econ_unfair = recode_attitude(econ_unfair),
    econ_onelaw = recode_attitude(econ_onelaw),
    econ_exploit = recode_attitude(econ_exploit)) %>% 
  rowwise() %>%
  mutate(
    social_conservatism = mean(c_across(c(soc_respect, soc_deathpen, soc_schools, soc_censor, soc_punish)), na.rm = TRUE),
    economic_leftism = mean(c_across(c(econ_redist, econ_bigbiz, econ_unfair, econ_onelaw, econ_exploit)), na.rm = TRUE),
    social_na_count = sum(is.na(c_across(c(soc_respect, soc_deathpen, soc_schools, soc_censor, soc_punish)))),
    economic_na_count = sum(is.na(c_across(c(econ_redist, econ_bigbiz, econ_unfair, econ_onelaw, econ_exploit))))
  ) %>%
  ungroup()

uk_data <- uk_data_test

summary(uk_data_test$social_conservatism)

uk_data_test %>% 
  filter(is.na(social_conservatism)) %>% 
  print()
```

above scale creation could be optimized for efficiency down the line. Rowwise operations decrease efficiency, could be eliminated.

Interpreting the scales: 
-   agreement with the social questions implies high social conservatism 
-   agreement with the economic questions implise high economic leftism

We expect a traditionally 'ri

#### 3) Quantify size of gender differences across age groups

##### Vote shares in 2024 election by Gender and Age Bands

```{r}
# create a visualization that shows, for each gender in each age band, their vote split in the 2024 election

# First, let's examine the vote choices available
cat("Available 2024 vote choices:\n")
print(unique(uk_data$pv_2024))

# Calculate weighted vote shares by gender and age group
vote_shares <- uk_data %>%
  filter(!is.na(pv_2024) & !is.na(gender) & !is.na(age)) %>%
  group_by(age, gender, pv_2024) %>%
  summarise(
    weighted_count = sum(wt, na.rm = TRUE),
    .groups = "keep"
  ) %>%
  group_by(age, gender) %>%
  mutate(
    total_weighted = sum(weighted_count),
    vote_share = weighted_count / total_weighted * 100
  ) %>%
  ungroup()

# Display the data
print("Vote shares by age, gender, and party:")
print(vote_shares)

# visualization - side-by-side comparison for key parties
major_parties <- vote_shares %>%
  filter(pv_2024 %in% c("con", "lab", "ldm", "rfm", "grn"))

ggplot(major_parties, aes(x = age, y = vote_share, fill = gender)) +
  geom_col(position = "dodge") +
  facet_wrap(~pv_2024, scales = "free_y") +
  labs(
    title = "Gender Differences in 2024 Vote Choice by Age Group",
    subtitle = "Side-by-side comparison for major parties",
    x = "Age Group",
    y = "Vote Share (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(face = "bold")
  ) +
  scale_fill_manual(values = c("male" = "lightblue", "female" = "pink"))
```

##### Average social conservatism by gender/age bands

```{r}
# Load survey package for proper weighted calculations
library(survey)

# Create survey design object
survey_design <- svydesign(
  ids = ~1,  # no clustering
  weights = ~wt,
  data = uk_data %>% filter(!is.na(social_conservatism) & !is.na(gender) & !is.na(age))
)

# Calculate survey-weighted means by age and gender
social_conservatism_means <- svyby(
  ~social_conservatism,
  ~age + gender,
  design = survey_design,
  FUN = svymean,
  na.rm = TRUE
)

# Convert to data frame and clean up
social_conservatism_means <- as.data.frame(social_conservatism_means) %>%
  rename(mean_social_conservatism = social_conservatism)

# Display the results
print("Survey-weighted means by age and gender:")
print(social_conservatism_means)

# Create barplot
ggplot(social_conservatism_means, aes(x = age, y = mean_social_conservatism, fill = gender)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = mean_social_conservatism - se,
                    ymax = mean_social_conservatism + se),
                position = position_dodge(width = 0.9), width = 0.25, alpha = 0.7) +
  labs(
    title = "Average Social Conservatism Scores by Age Group and Gender",
    subtitle = "Survey-weighted means with standard errors. Higher scores = more conservative",
    x = "Age Group",
    y = "Mean Social Conservatism Score",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("male" = "lightblue", "female" = "pink"))
```

##### Average economic leftism by gender/age bands

```{r}
# Calculate survey-weighted means for economic leftism by age and gender
economic_leftism_means <- svyby(
  ~economic_leftism,
  ~age + gender,
  design = survey_design,
  FUN = svymean,
  na.rm = TRUE
)

# Convert to data frame and clean up
economic_leftism_means <- as.data.frame(economic_leftism_means) %>%
  rename(mean_economic_leftism = economic_leftism)

# Display the results
print("Survey-weighted economic leftism means by age and gender:")
print(economic_leftism_means)

# Create barplot
ggplot(economic_leftism_means, aes(x = age, y = mean_economic_leftism, fill = gender)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = mean_economic_leftism - se,
                    ymax = mean_economic_leftism + se),
                position = position_dodge(width = 0.9), width = 0.25, alpha = 0.7) +
  labs(
    title = "Average Economic Leftism Scores by Age Group and Gender",
    subtitle = "Survey-weighted means with standard errors. Higher scores = more left-wing",
    x = "Age Group",
    y = "Mean Economic Leftism Score",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("male" = "lightblue", "female" = "pink"))
```

##### Average social conservatism by exact age

```{r}
# Create survey design object for exact age analysis
survey_design_exact_age <- svydesign(
  ids = ~1,
  weights = ~wt,
  data = uk_data %>% filter(!is.na(social_conservatism) & !is.na(gender) & !is.na(exact_age))
)

# Calculate survey-weighted means by exact age and gender
social_conservatism_by_age <- svyby(
  ~social_conservatism,
  ~exact_age + gender,
  design = survey_design_exact_age,
  FUN = svymean,
  na.rm = TRUE
)

# Convert to data frame and clean up
social_conservatism_by_age <- as.data.frame(social_conservatism_by_age) %>%
  rename(mean_social_conservatism = social_conservatism)

# Create line plot with confidence intervals
ggplot(social_conservatism_by_age, aes(x = exact_age, y = mean_social_conservatism, color = gender)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = mean_social_conservatism - 1.96*se,
                  ymax = mean_social_conservatism + 1.96*se,
                  fill = gender),
              alpha = 0.3, linetype = 0) +
  labs(
    title = "Average Social Conservatism by Exact Age and Gender",
    subtitle = "Survey-weighted means with 95% confidence intervals. Higher scores = more conservative",
    x = "Age (Years)",
    y = "Mean Social Conservatism Score",
    color = "Gender",
    fill = "Gender"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("male" = "steelblue", "female" = "coral")) +
  scale_fill_manual(values = c("male" = "steelblue", "female" = "coral")) +
  theme(legend.position = "bottom")
```

##### Average economic leftism by exact age

```{r}
# Calculate survey-weighted means for economic leftism by exact age and gender
economic_leftism_by_age <- svyby(
  ~economic_leftism,
  ~exact_age + gender,
  design = survey_design_exact_age,
  FUN = svymean,
  na.rm = TRUE
)

# Convert to data frame and clean up
economic_leftism_by_age <- as.data.frame(economic_leftism_by_age) %>%
  rename(mean_economic_leftism = economic_leftism)

# Create line plot with confidence intervals
ggplot(economic_leftism_by_age, aes(x = exact_age, y = mean_economic_leftism, color = gender)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = mean_economic_leftism - 1.96*se,
                  ymax = mean_economic_leftism + 1.96*se,
                  fill = gender),
              alpha = 0.3, linetype = 0) +
  labs(
    title = "Average Economic Leftism by Exact Age and Gender",
    subtitle = "Survey-weighted means with 95% confidence intervals. Higher scores = more left-wing",
    x = "Age (Years)",
    y = "Mean Economic Leftism Score",
    color = "Gender",
    fill = "Gender"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("male" = "steelblue", "female" = "coral")) +
  scale_fill_manual(values = c("male" = "steelblue", "female" = "coral")) +
  theme(legend.position = "bottom")
```

##### Gender Gap Summary Table

```{r}
# Gender Gap Summary Table using Survey Package
print("=== GENDER GAP SUMMARY TABLE ===")

# Calculate survey-weighted means for social conservatism
social_means_survey <- svyby(
  ~social_conservatism,
  ~age + gender,
  design = survey_design,
  FUN = svymean,
  na.rm = TRUE
) %>%
  as.data.frame() %>%
  select(age, gender, social_conservatism) %>%
  pivot_wider(names_from = gender, values_from = social_conservatism, names_prefix = "social_") %>%
  mutate(social_gap = social_male - social_female)

# Calculate survey-weighted means for economic leftism  
economic_means_survey <- svyby(
  ~economic_leftism,
  ~age + gender,
  design = survey_design,
  FUN = svymean,
  na.rm = TRUE
) %>%
  as.data.frame() %>%
  select(age, gender, economic_leftism) %>%
  pivot_wider(names_from = gender, values_from = economic_leftism, names_prefix = "economic_") %>%
  mutate(economic_gap = economic_male - economic_female)

# Statistical significance tests for each age group
age_groups <- unique(uk_data$age[!is.na(uk_data$age)])

# Function to perform survey-weighted t-tests
perform_survey_ttest <- function(age_group, variable) {
  # Filter data for this age group
  age_subset <- uk_data %>% 
    filter(age == age_group, !is.na(!!sym(variable)), !is.na(gender))
  
  if(nrow(age_subset) < 10) return(list(p_value = NA, t_stat = NA))
  
  # Create survey design for this subset
  design_subset <- svydesign(
    ids = ~1,
    weights = ~wt,
    data = age_subset
  )
  
  # Perform t-test comparing male vs female
  tryCatch({
    test_result <- svyttest(as.formula(paste(variable, "~ gender")), design_subset)
    list(p_value = test_result$p.value, t_stat = test_result$statistic)
  }, error = function(e) {
    list(p_value = NA, t_stat = NA)
  })
}

# Calculate significance tests for all age groups
significance_results <- map_dfr(age_groups, function(age_gr) {
  social_test <- perform_survey_ttest(age_gr, "social_conservatism")
  economic_test <- perform_survey_ttest(age_gr, "economic_leftism")
  
  tibble(
    age = age_gr,
    social_p_value = social_test$p_value,
    social_t_stat = social_test$t_stat,
    economic_p_value = economic_test$p_value,
    economic_t_stat = economic_test$t_stat
  )
})

# Combine into final summary table with significance tests
gender_gap_summary <- social_means_survey %>%
  left_join(economic_means_survey, by = "age") %>%
  left_join(significance_results, by = "age") %>%
  mutate(
    social_gap = round(social_gap, 3),
    economic_gap = round(economic_gap, 3),
    social_p_value = round(social_p_value, 4),
    economic_p_value = round(economic_p_value, 4),
    social_significant = case_when(
      is.na(social_p_value) ~ "N/A",
      social_p_value < 0.001 ~ "***",
      social_p_value < 0.01 ~ "**", 
      social_p_value < 0.05 ~ "*",
      social_p_value < 0.1 ~ ".",
      TRUE ~ ""
    ),
    economic_significant = case_when(
      is.na(economic_p_value) ~ "N/A",
      economic_p_value < 0.001 ~ "***",
      economic_p_value < 0.01 ~ "**",
      economic_p_value < 0.05 ~ "*", 
      economic_p_value < 0.1 ~ ".",
      TRUE ~ ""
    )
  ) %>%
  select(age, social_gap, social_p_value, social_significant, 
         economic_gap, economic_p_value, economic_significant) %>%
  arrange(age)

print(gender_gap_summary)
cat("\nSignificance codes: *** p<0.001, ** p<0.01, * p<0.05, . p<0.1\n")
```

In the above, **a positive gap indicates that males score higher than females on that dimension**.

The exists gap amongst younger age groups is statistically significant. It exits for both genders. Young men are more socially conservative than young women. Young men are also more economically right wing than young women. The gap narrows with age.

Now we'll drill down into more specific issue areas. These can inform PR, targeting and communication strategy for the FTSE company.

##### Specific issue divergence by gender and age groups

```{r}
# Individual Question Gender Gap Analysis - Overall Rankings
print("=== INDIVIDUAL QUESTION GENDER GAPS (OVERALL) ===")

# Define all individual attitude questions with descriptions
attitude_questions <- list(
  "soc_respect" = "Young people don't have enough respect for traditional British values",
  "soc_deathpen" = "Death penalty is most appropriate for some crimes", 
  "soc_schools" = "Schools should teach children to obey authority",
  "soc_censor" = "Censorship necessary to uphold moral standards",
  "soc_punish" = "Law breakers should get stiffer sentences",
  "econ_redist" = "Government should redistribute from better off to less well off",
  "econ_bigbiz" = "Big business take advantage of ordinary people",
  "econ_unfair" = "Ordinary people do not get fair share of nation's wealth", 
  "econ_onelaw" = "One law for rich, another for poor",
  "econ_exploit" = "Management will always try to get better of employees"
)

# Calculate overall gender gaps for each individual question with significance tests
individual_gaps_overall <- map_dfr(names(attitude_questions), function(var) {
  # Filter data for this question
  question_data <- uk_data %>% filter(!is.na(!!sym(var)), !is.na(gender))
  
  # Create survey design
  design_question <- svydesign(ids = ~1, weights = ~wt, data = question_data)
  
  # Calculate survey-weighted means by gender
  means_by_gender <- svyby(
    as.formula(paste("~", var)),
    ~gender,
    design = design_question,
    FUN = svymean,
    na.rm = TRUE
  ) %>%
    as.data.frame()
  
  # Perform survey-weighted t-test
  tryCatch({
    ttest_result <- svyttest(as.formula(paste(var, "~ gender")), design_question)
    p_value <- ttest_result$p.value
    t_stat <- ttest_result$statistic
  }, error = function(e) {
    p_value <- NA
    t_stat <- NA
  })
  
  # Extract male and female means
  male_mean <- means_by_gender[means_by_gender$gender == "male", var]
  female_mean <- means_by_gender[means_by_gender$gender == "female", var]
  
  # Calculate gap and significance
  gender_gap <- male_mean - female_mean
  significance <- case_when(
    is.na(p_value) ~ "N/A",
    p_value < 0.001 ~ "***",
    p_value < 0.01 ~ "**",
    p_value < 0.05 ~ "*",
    p_value < 0.1 ~ ".",
    TRUE ~ ""
  )
  
  # Create result
  tibble(
    question = var,
    description = attitude_questions[[var]],
    male_mean = round(male_mean, 3),
    female_mean = round(female_mean, 3),
    gender_gap = round(gender_gap, 3),
    p_value = round(p_value, 4),
    significance = significance,
    gap_magnitude = abs(gender_gap)
  )
}) %>%
  arrange(desc(gap_magnitude))

print(individual_gaps_overall)
cat("\nSignificance codes: *** p<0.001, ** p<0.01, * p<0.05, . p<0.1\n")
```

If we examine gender gaps across all ages, some notable trends emerge.

Censorship observed as the strongest point of disagreement, with women being 0.127 points higher on the agreement scale on average. Followed by the death penalty, where men are 0.069 points higher on the agreement scale.

Areas of issue agreement skew towards economic issues, such as government redistribution and predatory big business perceptions. Notably, stances on stiffer punishment sentences are fairly similar across genders.

```{r}
# Age-Stratified Individual Question Analysis
print("=== INDIVIDUAL QUESTION GENDER GAPS BY AGE GROUP ===")

# Calculate gender gaps for each question within each age group with significance tests
individual_gaps_by_age <- map_dfr(names(attitude_questions), function(var) {
  # Get unique age groups
  age_groups <- unique(uk_data$age[!is.na(uk_data$age)])
  
  # Calculate for each age group
  map_dfr(age_groups, function(age_gr) {
    # Filter data for this age group and question
    age_data <- uk_data %>% 
      filter(age == age_gr, !is.na(!!sym(var)), !is.na(gender))
    
    if(nrow(age_data) < 20) {
      return(tibble(
        question = var,
        age = age_gr, 
        male_mean = NA,
        female_mean = NA,
        gender_gap = NA,
        p_value = NA,
        significance = "N/A"
      ))
    }
    
    # Create survey design for this subset
    design_subset <- svydesign(ids = ~1, weights = ~wt, data = age_data)
    
    # Calculate means by gender
    means_by_gender <- svyby(
      as.formula(paste("~", var)),
      ~gender,
      design = design_subset,
      FUN = svymean,
      na.rm = TRUE
    ) %>%
      as.data.frame()
    
    # Perform survey-weighted t-test
    tryCatch({
      ttest_result <- svyttest(as.formula(paste(var, "~ gender")), design_subset)
      p_value <- ttest_result$p.value
    }, error = function(e) {
      p_value <- NA
    })
    
    # Extract means and calculate gap
    male_mean <- means_by_gender[means_by_gender$gender == "male", var]
    female_mean <- means_by_gender[means_by_gender$gender == "female", var]
    gender_gap <- male_mean - female_mean
    
    # Calculate significance
    significance <- case_when(
      is.na(p_value) ~ "N/A",
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      p_value < 0.1 ~ ".",
      TRUE ~ ""
    )
    
    tibble(
      question = var,
      age = age_gr,
      male_mean = round(male_mean, 3),
      female_mean = round(female_mean, 3), 
      gender_gap = round(gender_gap, 3),
      p_value = round(p_value, 4),
      significance = significance
    )
  })
})

# Create wide format tables with significance information
gaps_wide <- individual_gaps_by_age %>%
  left_join(
    tibble(question = names(attitude_questions), 
           description = unlist(attitude_questions)), 
    by = "question"
  ) %>%
  select(question, description, age, gender_gap, significance) %>%
  mutate(gap_with_sig = paste0(round(gender_gap, 3), significance)) %>%
  select(-gender_gap, -significance) %>%
  pivot_wider(names_from = age, values_from = gap_with_sig, names_prefix = "gap_") %>%
  arrange(question)

print(gaps_wide)

# Show detailed results with significance for largest gaps by age group
print("\n=== LARGEST GENDER GAPS BY AGE GROUP (with significance) ===")
largest_gaps_by_age <- individual_gaps_by_age %>%
  filter(!is.na(gender_gap)) %>%
  group_by(age) %>%
  slice_max(abs(gender_gap), n = 4) %>%
  left_join(
    tibble(question = names(attitude_questions), 
           description = unlist(attitude_questions)), 
    by = "question"
  ) %>%
  select(age, question, description, gender_gap, p_value, significance) %>%
  arrange(age, desc(abs(gender_gap)))

print(largest_gaps_by_age)

# Summary of significant gaps by age group
print("\n=== SIGNIFICANT GAPS SUMMARY BY AGE GROUP ===")
significant_gaps_summary <- individual_gaps_by_age %>%
  filter(!is.na(p_value), p_value < 0.05) %>%
  group_by(age) %>%
  summarise(
    n_significant = n(),
    avg_significant_gap = round(mean(abs(gender_gap)), 3),
    largest_gap = round(max(abs(gender_gap)), 3),
    .groups = "drop"
  ) %>%
  arrange(desc(n_significant))

print(significant_gaps_summary)
cat("\nSignificance codes: *** p<0.001, ** p<0.01, * p<0.05, . p<0.1\n")
```

After segmenting by age and accounting for statistical significance, young people diverge in terms of specific issues.

We also see that the average gap between genders declines with age, with the specific issue gaps shrinking towards middle age, and then increasing in old age.

Add visualizations for specific issue areas down the line. Good to know these differences. 

#### 4) Modelling stage - how does age, gender, other demographics predict ideology?

**Is the gender-age interaction the primary driver of ideological differences, or do other demographics matter more?** Informs whether the CEO should focus messaging strategies on generational gender gaps vs. other demographic segments.

```{r}
# Create survey design object

# Note that we could add stratification to this stage, such as though religion or age. We don't know the stratification scheme. 
survey_design_full <- svydesign(
  ids = ~1,  # No clustering in this dataset, assumes simple random sampling
  weights = ~wt,
  data = uk_data
)
```

##### M1: Social Conservatism Predictors

What demographic factors best predict social conservatism? Is the gender-age interaction significant even after controlling for education, region, etc.?

```{r}
# Model social conservatism with full demographic controls
model_social <- svyglm(
  social_conservatism ~ gender * age + education + ethnicity + region + 
                       household + socgrad + marital + religion,
  design = survey_design_full,
  family = gaussian()
)

# Display model summary
summary(model_social)

# Extract key coefficients for interpretation
social_coefs <- summary(model_social)$coefficients

# Model fit statistics
cat("\nModel Fit Statistics:\n")
cat("Degrees of Freedom:", model_social$df.residual, "\n")
cat("Deviance:", round(model_social$deviance, 3), "\n")

##  Check further diagnostics if wanted
#plot(model_social)

##  VIF Multicollinearity
library(car)
car::vif(model_social, type = 'terms')  # Check for multicollinearity

# Number of observations
nobs(model_social)  # Number of observations

```

Above shows similar trends to what we've been seeing and hypothesizing.

The main effect shows males are more conservative (+0.040), but the interactions reveal this gender gap narrows with age. In middle age (45-64), the male effect is actually reduced by about 0.067-0.088, suggesting older women catch up in conservatism.

Education: Lower education strongly predicts higher conservatism (+0.141) - one of the largest effects.
Religion: No religion has a massive negative effect (-0.157) - the strongest predictor. Hindus are more conservative (+0.054).
Geography: Scotland (-0.075), London (-0.031), and South regions are less conservative.
Housing: Social renters more conservative (+0.026), private renters less conservative (-0.037).

Note the reference categories in interpreting the above. 

##### M2: Economic Leftism Predictors

Are the drivers of economic vs social attitudes different? This matters for corporate positioning on economic vs social issues.

```{r}
# Model economic leftism with same demographic controls
model_economic <- svyglm(
  economic_leftism ~ gender * age + education + ethnicity + region + 
                    household + socgrad + marital + religion,
  design = survey_design_full,
  family = gaussian()
)

# Display model summary
summary(model_economic)

# Extract key coefficients for interpretation
economic_coefs <- summary(model_economic)$coefficients

# Model fit statistics
cat("\nModel Fit Statistics:\n")
cat("Degrees of Freedom:", model_economic$df.residual, "\n")
cat("Deviance:", round(model_economic$deviance, 3), "\n")

##  Check further diagnostics if wanted
#plot(model_economic)

##  VIF Multicollinearity
library(car)
car::vif(model_economic, type = 'terms')  # Check for multicollinearity

# Number of observations
nobs(model_economic)  # Number of observations

```

Again, similar trends as seen from our prior visuals and analysis.

Interpeting the economic leftism model:

Older men become much more economically right-wing than older women.

Social renters most left-wing (+0.12) - much stronger than in social conservatism

Lower social grades more left-wing (DE: +0.10, C2: +0.08)

Education has no effect (unlike strong effect in social conservatism)

North West, Scotland, Wales, Yorkshire more left-wing 

South East less left-wing (-0.03)

No religion associated with more economic leftism (+0.06)

Overall, housing is a more important driver in economic leftism than social conservatism.

Some classic political archetypes evidence in the data.

##### M3: Vote Choice Prediction

Do ideological attitudes predict vote better than demographics alone? This tests whether corporate positioning should focus on values vs identity.

```{r}
# Conservative vote model
model_vote_con <- svyglm(
  I(pv_2024 == "con") ~ gender * age + education + ethnicity + region,
  design = survey_design_full,
  family = binomial(link = "logit")
)
summary(model_vote_con)

# Labour vote model
model_vote_lab <- svyglm(
  I(pv_2024 == "lab") ~ gender * age + education + ethnicity + region,
  design = survey_design_full,
  family = binomial(link = "logit")
)
summary(model_vote_lab)

# Reform vote model
model_vote_rfm <- svyglm(
  I(pv_2024 == "rfm") ~ gender * age + education + ethnicity + region,
  design = survey_design_full,
  family = binomial(link = "logit")
)
summary(model_vote_rfm)

# Green vote model
model_vote_grn <- svyglm(
  I(pv_2024 == "grn") ~ gender * age + education + ethnicity + region,
  design = survey_design_full,
  family = binomial(link = "logit")
)
summary(model_vote_grn)

# Liberal Democrat vote model
model_vote_ldm <- svyglm(
  I(pv_2024 == "ldm") ~ gender * age + education + ethnicity + region,
  design = survey_design_full,
  family = binomial(link = "logit")
)
summary(model_vote_ldm)

```

#### 5) Segmented Modelling - Young vs Older Age Bands

**Are young people truly different, or just experiencing new intersection age + gender effects? How do our other predictors work differently for this cohort of respondents?**

NOTE: I don't know the methodology for creating the weights, so when we run our stratified models on specific age groups, our weights are no longer appropriate since we're no longer estimating on the full nationall representative sample, just our specific age groups. 

We will proceed with unweighted models with just lm(), and just acknowledge this limitation. Not useful to do the whole stratification again, just for this.

##### Young People Models (18-34)

```{r}
# Create young people subset
modeling_data_young <- uk_data %>%
  filter(age %in% c("18_TO_24", "25_TO_34")) %>%
  filter(!is.na(social_conservatism) & !is.na(economic_leftism) &
         !is.na(gender) & !is.na(education) & !is.na(ethnicity) & !is.na(region))

print(paste("Young people sample size:", nrow(modeling_data_young)))

# Social conservatism model - young people only (unweighted)
model_social_young <- lm(
  social_conservatism ~ gender + education + ethnicity + region + 
                       household + socgrad + marital + religion,
  data = modeling_data_young
)
summary(model_social_young)

# Economic leftism model - young people only (unweighted)
model_economic_young <- lm(
  economic_leftism ~ gender + education + ethnicity + region + 
                    household + socgrad + marital + religion,
  data = modeling_data_young
)
summary(model_economic_young)
```

##### Older People Models (35+)

```{r}
# Create older people subset
modeling_data_older <- uk_data %>%
  filter(age %in% c("35_TO_44", "45_TO_54", "55_TO_64", "65_TO_74","75_PLUS")) %>%
  filter(!is.na(social_conservatism) & !is.na(economic_leftism) &
         !is.na(gender) & !is.na(education) & !is.na(ethnicity) & !is.na(region))

print(paste("Older people sample size:", nrow(modeling_data_older)))

# Social conservatism model - older people only (unweighted)
model_social_older <- lm(
  social_conservatism ~ gender + education + ethnicity + region + 
                       household + socgrad + marital + religion,
  data = modeling_data_older
)
summary(model_social_older)

# Economic leftism model - older people only (unweighted)
model_economic_older <- lm(
  economic_leftism ~ gender + education + ethnicity + region + 
                    household + socgrad + marital + religion,
  data = modeling_data_older
)
summary(model_economic_older)
```

##### Compare Young vs Older Coefficients

```{r}
# Extract gender coefficients for comparison
print("=== GENDER EFFECTS COMPARISON: YOUNG VS OLDER ===")

# Social conservatism gender effects
social_young_gender <- summary(model_social_young)$coefficients["gendermale", c("Estimate", "Pr(>|t|)")]
social_older_gender <- summary(model_social_older)$coefficients["gendermale", c("Estimate", "Pr(>|t|)")]

cat("Social Conservatism - Male Effect:\n")
cat("Young (18-34):", round(social_young_gender[1], 3), "p =", round(social_young_gender[2], 3), "\n")
cat("Older (35+):", round(social_older_gender[1], 3), "p =", round(social_older_gender[2], 3), "\n")

# Economic leftism gender effects  
economic_young_gender <- summary(model_economic_young)$coefficients["gendermale", c("Estimate", "Pr(>|t|)")]
economic_older_gender <- summary(model_economic_older)$coefficients["gendermale", c("Estimate", "Pr(>|t|)")]

cat("\nEconomic Leftism - Male Effect:\n")
cat("Young (18-34):", round(economic_young_gender[1], 3), "p =", round(economic_young_gender[2], 3), "\n")
cat("Older (35+):", round(economic_older_gender[1], 3), "p =", round(economic_older_gender[2], 3), "\n")
```

#### 6) Presentation generation, visuals etc.

Come back to this at a later stage. Enough results for now to move onto the function generation.


#### 7) Extended Segment Analysis - Intersectionality

**What specifically is driving the change to the right-wing amongst younger men? Is the ongoing shift about women moving more left, or is it also about men moving more right**

**Can we find evidence for the claims posited in the article read by the CEO on this issue?**

##### Vote Switching Analysis: Left-to-Right Shifters 2019-2024

```{r}
# Identify vote switchers from left-wing to right-wing parties
# Define party classifications
left_parties <- c("lab", "grn", "ldm")  # Labour, Green, Lib Dem
right_parties <- c("con", "rfm")        # Conservative, Reform

# Create switching analysis dataset
vote_switchers <- uk_data %>%
  filter(!is.na(pv_2019) & !is.na(pv_2024)) %>%
  mutate(
    voted_left_2019 = pv_2019 %in% left_parties,
    voted_right_2024 = pv_2024 %in% right_parties,
    left_to_right_switch = voted_left_2019 & voted_right_2024
  )

# Summary of switching patterns
cat("=== VOTE SWITCHING SUMMARY ===\n")
switching_summary <- vote_switchers %>%
  group_by(voted_left_2019, voted_right_2024) %>%
  summarise(
    count = n(),
    weighted_count = sum(wt, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(percentage = round(weighted_count / sum(weighted_count) * 100, 1))

print(switching_summary)

# Focus on left-to-right switchers
left_to_right_switchers <- vote_switchers %>%
  filter(left_to_right_switch == TRUE)

cat("\nTotal left-to-right switchers:", nrow(left_to_right_switchers))
cat("\nWeighted count:", round(sum(left_to_right_switchers$wt, na.rm = TRUE)))

# Demographics of left-to-right switchers vs non-switchers
cat("\n=== DEMOGRAPHICS OF LEFT-TO-RIGHT SWITCHERS ===\n")

# Gender breakdown
gender_switching <- vote_switchers %>%
  group_by(gender, left_to_right_switch) %>%
  summarise(
    weighted_count = sum(wt, na.rm = TRUE),
    .groups = "keep"
  ) %>%
  group_by(gender) %>%
  mutate(
    total = sum(weighted_count),
    switch_rate = round(weighted_count[left_to_right_switch == TRUE] / total * 100, 1)
  ) %>%
  filter(left_to_right_switch == TRUE) %>%
  select(gender, switch_rate)

print("Left-to-right switching rates by gender:")
print(gender_switching)

# Age breakdown
age_switching <- vote_switchers %>%
  group_by(age, left_to_right_switch) %>%
  summarise(
    weighted_count = sum(wt, na.rm = TRUE),
    .groups = "keep"
  ) %>%
  group_by(age) %>%
  mutate(
    total = sum(weighted_count),
    switch_rate = round(weighted_count[left_to_right_switch == TRUE] / total * 100, 1)
  ) %>%
  filter(left_to_right_switch == TRUE) %>%
  select(age, switch_rate) %>%
  arrange(desc(switch_rate))

print("\nLeft-to-right switching rates by age:")
print(age_switching)

# Education breakdown
education_switching <- vote_switchers %>%
  filter(!is.na(education)) %>%
  group_by(education, left_to_right_switch) %>%
  summarise(
    weighted_count = sum(wt, na.rm = TRUE),
    .groups = "keep"
  ) %>%
  group_by(education) %>%
  mutate(
    total = sum(weighted_count),
    switch_rate = round(weighted_count[left_to_right_switch == TRUE] / total * 100, 1)
  ) %>%
  filter(left_to_right_switch == TRUE) %>%
  select(education, switch_rate)

print("\nLeft-to-right switching rates by education:")
print(education_switching)

# Predictive model for left-to-right switching
switching_model <- vote_switchers %>%
  filter(!is.na(gender) & !is.na(age) & !is.na(education) & !is.na(ethnicity))

# Create survey design for switching analysis
survey_design_switching <- svydesign(
  ids = ~1,
  weights = ~wt,
  data = switching_model
)

# Logistic regression predicting left-to-right switching
switch_prediction_model <- svyglm(
  left_to_right_switch ~ gender + age + education + ethnicity + region + religion,
  design = survey_design_switching,
  family = binomial(link = "logit")
)

summary(switch_prediction_model)

nobs(switch_prediction_model)
```

Being aged 25 to 34 is positively associated with switching from left to right in terms of party vote. Further analysis can be done on this and on the specific points, if it's deemed necessary down the line.

**Further steps**

Need to narrow down an effective methodology for examining segmented trends within the survey model approach. We can't say if these samples generalize to the entirety of the UK since segmentation + weighting disrupts the survey design.

Currently thinking to create a polarization index, which measures how far someone is from the mean on both social and economic dimensions. Then we can see who is most polarized, and what predicts this.

- Religious intersectionality: gender gaps within Christian/Muslim/secular young people
- Ethnic polarization matrix: white vs minority young men/women patterns  
- Education-class intersections: degree vs non-degree effects on gender gaps
- Geographic mapping: urban/rural and constituency-level polarization hotspots
- Polarization intensity metrics: identify most extreme vs moderate young segments
- Attitude clustering: natural groupings and messaging archetypes for corporate strategy
- "Movement" analysis: who is shifting away from older generational patterns most
- Issue-specific drivers: which attitudes (social vs economic) drive overall polarization

